<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Biometric System</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="dashboard-title">
            <h1>üëë Admin Dashboard</h1>
        </div>
        <div class="user-info">
            <div>
                <div style="font-weight: 600;" id="user-login">Loading...</div>
                <div style="font-size: 0.875rem; color: var(--text-muted);">Administrator</div>
            </div>
            <div class="user-avatar">A</div>
            <button class="btn btn-secondary btn-sm" onclick="BiometricAPI.logout()">
                Logout
            </button>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Stats Cards -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary">üë•</div>
                <div class="stat-content">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value" id="stat-users">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon success">üìä</div>
                <div class="stat-content">
                    <div class="stat-label">Avg Quality</div>
                    <div class="stat-value" id="stat-quality">0%</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warning">üîê</div>
                <div class="stat-content">
                    <div class="stat-label">Database</div>
                    <div class="stat-value" id="stat-encrypted">Encrypted</div>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container"></div>

        <!-- Action Buttons -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">‚ö° Quick Actions</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-3">
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        ‚ûï Add User
                    </button>
                    <button class="btn btn-info" onclick="showLoadFolderModal()">
                        üìÅ Load Folder
                    </button>
                    <button class="btn btn-warning" onclick="showVerifyModal()">
                        üîç Verify (1:1)
                    </button>
                    <button class="btn btn-success" onclick="showIdentifyModal()">
                        üéØ Identify (1:N)
                    </button>
                    <button class="btn btn-secondary" onclick="refreshUsersList()">
                        üîÑ Refresh List
                    </button>
                    <button class="btn btn-danger" onclick="confirmDeleteAll()">
                        üóëÔ∏è Delete All
                    </button>
                </div>
            </div>
        </div>

        <!-- Users List -->
        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <h3 class="card-title">üìã Enrolled Users</h3>
                <span class="badge badge-info" id="user-count-badge">0 users</span>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Quality</th>
                                <th>Minutiae</th>
                                <th>Samples</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
                                    <div>No users enrolled yet. Click "Add User" to get started.</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Real-time Updates Log -->
        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <h3 class="card-title">üì° Real-time Updates</h3>
                <button class="btn btn-sm btn-secondary" onclick="clearUpdateLog()">Clear</button>
            </div>
            <div class="card-body">
                <div id="updates-log" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        Waiting for updates...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div style="text-align: center;">
            <div class="spinner" style="margin: 0 auto 1rem;"></div>
            <div id="loading-message" style="color: white; font-weight: 600;">Loading...</div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        // Check authentication
        if (!BiometricAPI.requireAuth('admin')) {
            throw new Error('Unauthorized');
        }

        // Update user info
        const user = BiometricAPI.getCurrentUser();
        document.getElementById('user-login').textContent = user.login;

        // ====================================================================
        // INITIALIZATION
        // ====================================================================

        async function init() {
            try {
                // Load statistics
                await loadStats();
                
                // Load users
                await refreshUsersList();
                
            } catch (error) {
                console.error('Initialization error:', error);
                BiometricAPI.showAlert('alert-container', 'Failed to initialize: ' + error.message, 'danger');
            }
        }

        // ====================================================================
        // STATISTICS
        // ====================================================================

        async function loadStats() {
            try {
                const stats = await BiometricAPI.getStats();
                
                document.getElementById('stat-users').textContent = stats.num_users;
                document.getElementById('stat-quality').textContent = 
                    (stats.avg_template_quality * 100).toFixed(1) + '%';
                document.getElementById('stat-encrypted').textContent = 
                    stats.encrypted ? 'Encrypted ‚úì' : 'Not Encrypted ‚ö†';
                
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // ====================================================================
        // USERS LIST
        // ====================================================================

        async function refreshUsersList() {
            BiometricAPI.showLoading('Loading users...');
            
            try {
                const data = await BiometricAPI.getUsers();
                const users = data.users || [];
                
                const tbody = document.getElementById('users-tbody');
                
                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
                                <div>No users enrolled yet. Click "Add User" to get started.</div>
                            </td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = users.map(user => `
                        <tr>
                            <td><strong>${user.user_id}</strong></td>
                            <td>${user.name}</td>
                            <td>${BiometricAPI.formatQuality(user.quality)}</td>
                            <td>${user.num_minutiae}</td>
                            <td>${user.num_samples}</td>
                            <td>${BiometricAPI.formatTimestamp(user.created_at)}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="showUserDetails('${user.user_id}')">
                                    View
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="showUpdateUserModal('${user.user_id}', '${user.name}')">
                                    Edit
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDeleteUser('${user.user_id}')">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
                
                document.getElementById('user-count-badge').textContent = 
                    `${users.length} user${users.length !== 1 ? 's' : ''}`;
                
                // Refresh stats
                await loadStats();
                
            } catch (error) {
                console.error('Failed to load users:', error);
                BiometricAPI.showAlert('alert-container', 'Failed to load users: ' + error.message, 'danger');
            } finally {
                BiometricAPI.hideLoading();
            }
        }

        // ====================================================================
        // ADD USER
        // ====================================================================

        function showAddUserModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>‚ûï Add New User</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <form id="add-user-form">
                            <div class="form-group">
                                <label class="form-label">User ID</label>
                                <input type="text" id="add-user-id" class="form-input" required placeholder="e.g., user001">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" id="add-user-name" class="form-input" required placeholder="e.g., John Doe">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fingerprint Images (2-5 recommended)</label>
                                <div class="file-upload" onclick="document.getElementById('add-user-images').click()">
                                    <input type="file" id="add-user-images" accept="image/*" multiple required>
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÅ</div>
                                    <div>Click to select images</div>
                                    <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">
                                        Multiple images improve accuracy
                                    </div>
                                </div>
                                <div id="add-user-images-preview" style="margin-top: 1rem;"></div>
                            </div>
                        </form>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            Cancel
                        </button>
                        <button class="btn btn-primary" onclick="submitAddUser()">
                            Add User
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Preview images
            document.getElementById('add-user-images').addEventListener('change', (e) => {
                const preview = document.getElementById('add-user-images-preview');
                const files = e.target.files;
                
                if (files.length > 0) {
                    preview.innerHTML = `<strong>${files.length} image(s) selected</strong>`;
                } else {
                    preview.innerHTML = '';
                }
            });
        }

        async function submitAddUser() {
            const userId = document.getElementById('add-user-id').value.trim();
            const name = document.getElementById('add-user-name').value.trim();
            const files = document.getElementById('add-user-images').files;
            
            if (!userId || !name || files.length === 0) {
                alert('Please fill all fields and select at least one image');
                return;
            }
            
            BiometricAPI.showLoading('Enrolling user...');
            
            try {
                // Add user with files directly
                const result = await BiometricAPI.addUser(userId, name, files);
                
                // Close modal
                document.querySelector('.modal').remove();
                
                // Show success
                BiometricAPI.showAlert('alert-container', 
                    `User "${name}" added successfully! Quality: ${(result.quality * 100).toFixed(1)}%`, 
                    'success');
                
                // Refresh list
                await refreshUsersList();
                
            } catch (error) {
                console.error('Failed to add user:', error);
                BiometricAPI.showAlert('alert-container', 'Failed to add user: ' + error.message, 'danger');
            } finally {
                BiometricAPI.hideLoading();
            }
        }

        // ====================================================================
        // UPDATE USER
        // ====================================================================

        function showUpdateUserModal(userId, currentName) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è Update User: ${userId}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <form id="update-user-form">
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" id="update-user-name" class="form-input" value="${currentName}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Fingerprint Images (optional)</label>
                                <div class="file-upload" onclick="document.getElementById('update-user-images').click()">
                                    <input type="file" id="update-user-images" accept="image/*" multiple>
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÅ</div>
                                    <div>Click to re-enroll with new images</div>
                                </div>
                                <div id="update-user-images-preview" style="margin-top: 1rem;"></div>
                            </div>
                        </form>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            Cancel
                        </button>
                        <button class="btn btn-warning" onclick="submitUpdateUser('${userId}')">
                            Update
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Preview images
            document.getElementById('update-user-images').addEventListener('change', (e) => {
                const preview = document.getElementById('update-user-images-preview');
                const files = e.target.files;
                
                if (files.length > 0) {
                    preview.innerHTML = `<strong>${files.length} new image(s) selected</strong>`;
                } else {
                    preview.innerHTML = '';
                }
            });
        }

        async function submitUpdateUser(userId) {
            const name = document.getElementById('update-user-name').value.trim();
            const files = document.getElementById('update-user-images').files;
            
            BiometricAPI.showLoading('Updating user...');
            
            try {
                // Pass files directly (not base64)
                await BiometricAPI.updateUser(userId, name, files.length > 0 ? files : null);
                
                document.querySelector('.modal').remove();
                
                BiometricAPI.showAlert('alert-container', `User "${userId}" updated successfully!`, 'success');
                
                await refreshUsersList();
                
            } catch (error) {
                console.error('Failed to update user:', error);
                BiometricAPI.showAlert('alert-container', 'Failed to update user: ' + error.message, 'danger');
            } finally {
                BiometricAPI.hideLoading();
            }
        }

        // ====================================================================
        // DELETE USER
        // ====================================================================

        function confirmDeleteUser(userId) {
            // Show confirmation modal instead of simple confirm()
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>‚ö†Ô∏è Confirm Delete</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <span style="font-size: 2rem;">‚ö†Ô∏è</span>
                            <div>
                                <strong>Are you sure you want to delete this user?</strong><br><br>
                                User ID: <strong>${userId}</strong><br><br>
                                This action cannot be undone!
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            Cancel
                        </button>
                        <button class="btn btn-danger" onclick="deleteUser('${userId}'); this.closest('.modal').remove();">
                            üóëÔ∏è Yes, Delete User
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function deleteUser(userId) {
            BiometricAPI.showLoading('Deleting user...');
            
            try {
                await BiometricAPI.deleteUser(userId);
                
                BiometricAPI.showAlert('alert-container', `User "${userId}" deleted successfully!`, 'success');
                
                await refreshUsersList();
                
            } catch (error) {
                console.error('Failed to delete user:', error);
                BiometricAPI.showAlert('alert-container', 'Failed to delete user: ' + error.message, 'danger');
            } finally {
                BiometricAPI.hideLoading();
            }
        }

        // ====================================================================
        // DELETE ALL
        // ====================================================================

        function confirmDeleteAll() {
            // Show confirmation modal instead of simple confirm()
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>‚ö†Ô∏è Confirm Delete</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <span style="font-size: 2rem;">‚ö†Ô∏è</span>
                            <div>
                                <strong>Are you sure you want to delete all users?</strong><br><br>
                                This action cannot be undone!
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            Cancel
                        </button>
                        <button class="btn btn-danger" onclick="deleteAllUsers(); this.closest('.modal').remove();">
                            üóëÔ∏è Yes, Delete ALL USERS!
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function deleteAllUsers() {
            BiometricAPI.showLoading('Deleting all users...');
            
            try {
                const result = await BiometricAPI.deleteAllUsers();
                
                BiometricAPI.showAlert('alert-container', 
                    `Successfully deleted ${result.count} user(s)!`, 
                    'warning');
                
                await refreshUsersList();
                
            } catch (error) {
                console.error('Failed to delete all users:', error);
                BiometricAPI.showAlert('alert-container', 'Failed to delete users: ' + error.message, 'danger');
            } finally {
                BiometricAPI.hideLoading();
            }
        }

        // ====================================================================
        // LOAD FOLDER
        // ====================================================================

        function showLoadFolderModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üìÅ Load Fingerprints from Folder</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <span>‚Ñπ</span>
                            <span>
                                <strong>Expected file format:</strong><br>
                                Flat folder with files named: <code>{userID}_{sampleNumber}.tif</code><br><br>
                                <code style="display: block; margin-top: 0.5rem; background: var(--bg-dark); padding: 0.5rem; border-radius: 0.25rem;">
                                folder/<br>
                                &nbsp;&nbsp;101_1.tif<br>
                                &nbsp;&nbsp;101_2.tif<br>
                                &nbsp;&nbsp;...<br>
                                &nbsp;&nbsp;101_8.tif<br>
                                &nbsp;&nbsp;102_1.tif<br>
                                &nbsp;&nbsp;102_2.tif<br>
                                &nbsp;&nbsp;...
                                </code>
                                <br>
                                <strong>Requirements:</strong><br>
                                ‚Ä¢ Minimum 5 images per user<br>
                                ‚Ä¢ All images will be processed (no maximum)<br>
                                ‚Ä¢ User ID will be the number from filename<br>
                                ‚Ä¢ Existing users will be skipped
                            </span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Folder Path</label>
                            <input type="text" id="load-folder-path" class="form-input" 
                                   placeholder="e.g., C:/fingerprints or C:\\fingerprints">
                            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-muted);">
                                Use forward slashes (/) or double backslashes (\\\\)
                            </div>
                        </div>
                        <div id="load-folder-progress" style="margin-top: 1rem;"></div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            Cancel
                        </button>
                        <button class="btn btn-info" onclick="submitLoadFolder()">
                            üìÅ Load Folder
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function submitLoadFolder() {
            const folderPath = document.getElementById('load-folder-path').value.trim();
            
            if (!folderPath) {
                alert('Please enter a folder path');
                return;
            }
            
            const progressDiv = document.getElementById('load-folder-progress');
            progressDiv.innerHTML = `
                <div class="alert alert-info">
                    <span>‚è≥</span>
                    <span>Processing folder... This may take several minutes depending on the number of users and images.</span>
                </div>
            `;
            
            BiometricAPI.showLoading('Loading fingerprints from folder...');
            
            try {
                const result = await BiometricAPI.loadTemplatesFromFolder(folderPath);
                
                document.querySelector('.modal').remove();
                
                // Show detailed results
                let message = `<strong>Folder Processing Complete!</strong><br><br>`;
                message += `‚úÖ Enrolled: ${result.enrolled}<br>`;
                message += `‚ö†Ô∏è Skipped: ${result.skipped}<br>`;
                message += `‚ùå Errors: ${result.errors}<br>`;
                message += `üìä Total users found: ${result.total_users}`;
                
                BiometricAPI.showAlert('alert-container', message, 
                    result.enrolled > 0 ? 'success' : 'warning');
                
                await refreshUsersList();
                
            } catch (error) {
                console.error('Failed to load folder:', error);
                progressDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <span>‚ùå</span>
                        <span>${error.message}</span>
                    </div>
                `;
            } finally {
                BiometricAPI.hideLoading();
            }
        }

        // ====================================================================
        // VERIFY (1:1)
        // ====================================================================

        function showVerifyModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üîç Verify Fingerprint (1:1)</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">User ID</label>
                            <input type="text" id="verify-user-id" class="form-input" placeholder="e.g., user001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fingerprint Image</label>
                            <div class="file-upload" onclick="document.getElementById('verify-image').click()">
                                <input type="file" id="verify-image" accept="image/*" required>
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üñêÔ∏è</div>
                                <div>Click to select fingerprint image</div>
                            </div>
                            <div id="verify-image-preview" style="margin-top: 1rem; text-align: center;"></div>
                        </div>
                        <div id="verify-result" style="margin-top: 1.5rem;"></div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            Close
                        </button>
                        <button class="btn btn-warning" onclick="submitVerify()">
                            Verify
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Preview image with TIF support (Canvas PNG conversion)
            document.getElementById('verify-image').addEventListener('change', (e) => {
                const preview = document.getElementById('verify-image-preview');
                const file = e.target.files[0];
                
                if (file) {
                    console.log(`üìÅ Verify file selected: ${file.name} ${file.type} ${file.size} bytes`);
                    
                    const reader = new FileReader();
                    reader.onload = (readerEvent) => {
                        const dataUrl = readerEvent.target.result;
                        console.log(`‚úÖ Verify file read, data length: ${dataUrl.length}`);
                        
                        // Try to load as image
                        const img = new Image();
                        
                        img.onload = () => {
                            console.log(`‚úÖ Verify image decoded: ${img.width}x${img.height}`);
                            
                            // Convert to PNG using canvas
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            const pngDataUrl = canvas.toDataURL('image/png');
                            console.log(`‚úÖ Verify converted to PNG`);
                            
                            preview.innerHTML = `<img src="${pngDataUrl}" style="max-width: 200px; border-radius: 0.5rem;">`;
                        };
                        
                        img.onerror = () => {
                            console.log(`‚ö†Ô∏è Browser cannot render this format, showing placeholder`);
                            
                            // Show placeholder with file info
                            preview.innerHTML = `
                                <div style="max-width: 200px; padding: 1rem; border: 2px dashed var(--border-color); border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìÑ</div>
                                    <div style="font-size: 0.875rem; color: var(--text-muted);">
                                        ${file.name}<br>
                                        ${file.type || 'unknown'}<br>
                                        File will be processed on server
                                    </div>
                                </div>
                            `;
                        };
                        
                        img.src = dataUrl;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        async function submitVerify() {
            const userId = document.getElementById('verify-user-id').value.trim();
            const file = document.getElementById('verify-image').files[0];
            
            if (!userId || !file) {
                alert('Please enter user ID and select an image');
                return;
            }
            
            BiometricAPI.showLoading('Verifying fingerprint...');
            
            try {
                // Use FormData instead of base64
                const result = await BiometricAPI.verifyFingerprint(userId, file);
                
                const resultDiv = document.getElementById('verify-result');
                
                if (result.match) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <span style="font-size: 2rem;">‚úì</span>
                            <div>
                                <strong>VERIFIED!</strong><br>
                                Score: ${(result.score * 100).toFixed(1)}%<br>
                                Threshold: ${(result.threshold * 100).toFixed(0)}%
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <span style="font-size: 2rem;">‚úó</span>
                            <div>
                                <strong>NOT VERIFIED</strong><br>
                                Score: ${(result.score * 100).toFixed(1)}%<br>
                                Threshold: ${(result.threshold * 100).toFixed(0)}%
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Verification failed:', error);
                const resultDiv = document.getElementById('verify-result');
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <span>‚úó</span>
                        <span>Verification failed: ${error.message}</span>
                    </div>
                `;
            } finally {
                BiometricAPI.hideLoading();
            }
        }

        // ====================================================================
        // IDENTIFY (1:N)
        // ====================================================================

        function showIdentifyModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üéØ Identify Fingerprint (1:N)</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Fingerprint Image</label>
                            <div class="file-upload" onclick="document.getElementById('identify-image').click()">
                                <input type="file" id="identify-image" accept="image/*" required>
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üñêÔ∏è</div>
                                <div>Click to select fingerprint image</div>
                            </div>
                            <div id="identify-image-preview" style="margin-top: 1rem; text-align: center;"></div>
                        </div>
                        <div id="identify-result" style="margin-top: 1.5rem;"></div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            Close
                        </button>
                        <button class="btn btn-success" onclick="submitIdentify()">
                            Identify
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Preview image with TIF support (Canvas PNG conversion)
            document.getElementById('identify-image').addEventListener('change', (e) => {
                const preview = document.getElementById('identify-image-preview');
                const file = e.target.files[0];
                
                if (file) {
                    console.log(`üìÅ Identify file selected: ${file.name} ${file.type} ${file.size} bytes`);
                    
                    const reader = new FileReader();
                    reader.onload = (readerEvent) => {
                        const dataUrl = readerEvent.target.result;
                        console.log(`‚úÖ Identify file read, data length: ${dataUrl.length}`);
                        
                        // Try to load as image
                        const img = new Image();
                        
                        img.onload = () => {
                            console.log(`‚úÖ Identify image decoded: ${img.width}x${img.height}`);
                            
                            // Convert to PNG using canvas
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            const pngDataUrl = canvas.toDataURL('image/png');
                            console.log(`‚úÖ Identify converted to PNG`);
                            
                            preview.innerHTML = `<img src="${pngDataUrl}" style="max-width: 200px; border-radius: 0.5rem;">`;
                        };
                        
                        img.onerror = () => {
                            console.log(`‚ö†Ô∏è Browser cannot render this format, showing placeholder`);
                            
                            // Show placeholder with file info
                            preview.innerHTML = `
                                <div style="max-width: 200px; padding: 1rem; border: 2px dashed var(--border-color); border-radius: 0.5rem; text-align: center;">
                                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìÑ</div>
                                    <div style="font-size: 0.875rem; color: var(--text-muted);">
                                        ${file.name}<br>
                                        ${file.type || 'unknown'}<br>
                                        File will be processed on server
                                    </div>
                                </div>
                            `;
                        };
                        
                        img.src = dataUrl;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        async function submitIdentify() {
            const file = document.getElementById('identify-image').files[0];
            
            if (!file) {
                alert('Please select an image');
                return;
            }
            
            BiometricAPI.showLoading('Identifying fingerprint...');
            
            try {
                // Use FormData instead of base64
                const result = await BiometricAPI.identifyFingerprint(file);
                
                const resultDiv = document.getElementById('identify-result');
                
                if (result.identified) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <span style="font-size: 2rem;">‚úì</span>
                            <div>
                                <strong>IDENTIFIED!</strong><br>
                                User ID: ${result.best_match_id}<br>
                                Score: ${(result.best_score * 100).toFixed(1)}%<br>
                                Threshold: ${(result.threshold * 100).toFixed(0)}%
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <span style="font-size: 2rem;">‚úó</span>
                            <div>
                                <strong>NOT IDENTIFIED</strong><br>
                                No match found in database<br>
                                Searched ${result.total_users} user(s)
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Identification failed:', error);
                const resultDiv = document.getElementById('identify-result');
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <span>‚úó</span>
                        <span>Identification failed: ${error.message}</span>
                    </div>
                `;
            } finally {
                BiometricAPI.hideLoading();
            }
        }

        // ====================================================================
        // USER DETAILS
        // ====================================================================

        async function showUserDetails(userId) {
            BiometricAPI.showLoading('Loading user details...');
            
            try {
                const user = await BiometricAPI.getUser(userId);
                
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>üë§ User Details: ${user.user_id}</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div class="grid grid-2">
                                <div>
                                    <strong>User ID:</strong><br>${user.user_id}
                                </div>
                                <div>
                                    <strong>Name:</strong><br>${user.name || 'N/A'}
                                </div>
                                <div>
                                    <strong>Quality:</strong><br>
                                    ${user.quality !== undefined ? BiometricAPI.formatQuality(user.quality) : 'N/A'}
                                </div>
                                <div>
                                    <strong>Created:</strong><br>
                                    ${user.created_at ? BiometricAPI.formatTimestamp(user.created_at) : 'N/A'}
                                </div>
                                <div>
                                    <strong>Updated:</strong><br>
                                    ${user.updated_at ? BiometricAPI.formatTimestamp(user.updated_at) : 'N/A'}
                                </div>
                                <div>
                                    <strong>Created By:</strong><br>${user.created_by || 'N/A'}
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Failed to load user details:', error);
                alert('Failed to load user details: ' + error.message);
            } finally {
                BiometricAPI.hideLoading();
            }
        }

        function clearUpdateLog() {
            document.getElementById('updates-log').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    Waiting for updates...
                </div>
            `;
        }

        // ====================================================================
        // START
        // ====================================================================

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

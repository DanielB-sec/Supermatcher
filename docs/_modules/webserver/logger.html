

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>webserver.logger &mdash; Supermatcher 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Supermatcher
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Supermatcher</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">webserver.logger</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for webserver.logger</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Webserver Logging System</span>

<span class="sd">This module provides a structured logging system for the webserver, supporting multiple log files with automatic rotation and convenience functions for logging access, authentication, biometric operations, errors, jobs, and server events. It also supports structured JSON logging for external aggregation and log cleanup utilities.</span>

<span class="sd">Log Files:</span>
<span class="sd">    - access.log: HTTP requests (IP, endpoint, status, duration)</span>
<span class="sd">    - auth.log: Authentication events (login, logout, failed attempts)</span>
<span class="sd">    - biometric.log: Biometric operations (enroll, verify, identify results)</span>
<span class="sd">    - error.log: Application errors and exceptions</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging.handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">RotatingFileHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">LOG_DIR</span><span class="p">,</span> <span class="n">VERBOSE</span>


<span class="c1"># Ensure log directory exists</span>
<span class="n">LOG_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># Log file paths</span>
<span class="n">ACCESS_LOG</span> <span class="o">=</span> <span class="n">LOG_DIR</span> <span class="o">/</span> <span class="s2">&quot;access.log&quot;</span>
<span class="n">AUTH_LOG</span> <span class="o">=</span> <span class="n">LOG_DIR</span> <span class="o">/</span> <span class="s2">&quot;auth.log&quot;</span>
<span class="n">BIOMETRIC_LOG</span> <span class="o">=</span> <span class="n">LOG_DIR</span> <span class="o">/</span> <span class="s2">&quot;biometric.log&quot;</span>
<span class="n">ERROR_LOG</span> <span class="o">=</span> <span class="n">LOG_DIR</span> <span class="o">/</span> <span class="s2">&quot;error.log&quot;</span>


<span class="c1"># Log formats</span>
<span class="n">DETAILED_FORMAT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> [</span><span class="si">%(levelname)s</span><span class="s1">] </span><span class="si">%(name)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
<span class="n">JSON_FORMAT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(message)s</span><span class="s1">&#39;</span>  <span class="c1"># For structured JSON logs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_create_rotating_handler</span><span class="p">(</span>
    <span class="n">log_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">max_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="c1"># 10MB</span>
    <span class="n">backup_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">formatter_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RotatingFileHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a rotating file handler for logging with automatic file rotation.</span>

<span class="sd">    Args:</span>
<span class="sd">        log_file (Path): Path to the log file.</span>
<span class="sd">        max_bytes (int): Maximum file size in bytes before rotation occurs. Defaults to 10MB.</span>
<span class="sd">        backup_count (int): Number of backup files to retain. Defaults to 5.</span>
<span class="sd">        formatter_string (Optional[str]): Log format string. If None, uses DETAILED_FORMAT.</span>

<span class="sd">    Returns:</span>
<span class="sd">        RotatingFileHandler: Configured rotating file handler for logging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">RotatingFileHandler</span><span class="p">(</span>
        <span class="n">log_file</span><span class="p">,</span>
        <span class="n">maxBytes</span><span class="o">=</span><span class="n">max_bytes</span><span class="p">,</span>
        <span class="n">backupCount</span><span class="o">=</span><span class="n">backup_count</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span>
    <span class="p">)</span>
    
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">formatter_string</span> <span class="ow">or</span> <span class="n">DETAILED_FORMAT</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">handler</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_logger</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">log_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get or create a logger with a rotating file handler and optional console output.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): Logger name.</span>
<span class="sd">        log_file (Path): Path to the log file.</span>
<span class="sd">        level (int): Logging level (e.g., logging.INFO, logging.ERROR). Defaults to INFO.</span>

<span class="sd">    Returns:</span>
<span class="sd">        logging.Logger: Configured logger instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    
    <span class="c1"># Avoid duplicate handlers</span>
    <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">logger</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Don&#39;t propagate to root logger</span>
    
    <span class="c1"># Add rotating file handler</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">_create_rotating_handler</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    
    <span class="c1"># Add console handler if verbose</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">DETAILED_FORMAT</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">logger</span>


<span class="c1"># Create specialized loggers</span>
<span class="n">access_logger</span> <span class="o">=</span> <span class="n">_get_logger</span><span class="p">(</span><span class="s2">&quot;webserver.access&quot;</span><span class="p">,</span> <span class="n">ACCESS_LOG</span><span class="p">)</span>
<span class="n">auth_logger</span> <span class="o">=</span> <span class="n">_get_logger</span><span class="p">(</span><span class="s2">&quot;webserver.auth&quot;</span><span class="p">,</span> <span class="n">AUTH_LOG</span><span class="p">)</span>
<span class="n">biometric_logger</span> <span class="o">=</span> <span class="n">_get_logger</span><span class="p">(</span><span class="s2">&quot;webserver.biometric&quot;</span><span class="p">,</span> <span class="n">BIOMETRIC_LOG</span><span class="p">)</span>
<span class="n">error_logger</span> <span class="o">=</span> <span class="n">_get_logger</span><span class="p">(</span><span class="s2">&quot;webserver.error&quot;</span><span class="p">,</span> <span class="n">ERROR_LOG</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>


<span class="c1"># Convenience functions</span>

<div class="viewcode-block" id="log_access">
<a class="viewcode-back" href="../../webserver.html#webserver.logger.log_access">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_access</span><span class="p">(</span>
    <span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">duration_ms</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log an HTTP access event to the access log.</span>

<span class="sd">    Args:</span>
<span class="sd">        ip (str): Client IP address.</span>
<span class="sd">        method (str): HTTP method (GET, POST, etc.).</span>
<span class="sd">        endpoint (str): Request endpoint path.</span>
<span class="sd">        status_code (int): HTTP status code returned.</span>
<span class="sd">        duration_ms (float): Request duration in milliseconds.</span>
<span class="sd">        user (Optional[str]): Authenticated username, if available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; user=</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">user</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">access_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">duration_ms</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">ms</span><span class="si">{</span><span class="n">user_info</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="log_auth">
<a class="viewcode-back" href="../../webserver.html#webserver.logger.log_auth">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_auth</span><span class="p">(</span>
    <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">login</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log an authentication event to the authentication log.</span>

<span class="sd">    Args:</span>
<span class="sd">        event (str): Event type (e.g., LOGIN, LOGOUT, TOKEN_REFRESH).</span>
<span class="sd">        login (str): Username involved in the event.</span>
<span class="sd">        ip (str): Client IP address.</span>
<span class="sd">        success (bool): Whether the authentication operation succeeded. Defaults to True.</span>
<span class="sd">        details (Optional[str]): Additional details about the event.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;SUCCESS&quot;</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="s2">&quot;FAILED&quot;</span>
    <span class="n">detail_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="n">details</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">details</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    
    <span class="n">auth_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> - login=</span><span class="si">{</span><span class="n">login</span><span class="si">}</span><span class="s2"> ip=</span><span class="si">{</span><span class="n">ip</span><span class="si">}{</span><span class="n">detail_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="log_biometric">
<a class="viewcode-back" href="../../webserver.html#webserver.logger.log_biometric">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_biometric</span><span class="p">(</span>
    <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">result</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">performed_by</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log a biometric operation event to the biometric log.</span>

<span class="sd">    Args:</span>
<span class="sd">        operation (str): Operation type (ENROLL, VERIFY, IDENTIFY).</span>
<span class="sd">        user_id (Optional[str]): Target user ID (for enroll/verify) or None (for identify).</span>
<span class="sd">        result (str): Operation result (e.g., SUCCESS, FAILURE, NO_MATCH).</span>
<span class="sd">        details (Optional[Dict[str, Any]]): Additional details such as score, quality, matches, etc.</span>
<span class="sd">        performed_by (Optional[str]): Username who performed the operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;user_id=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">user_id</span> <span class="k">else</span> <span class="s2">&quot;user_id=None&quot;</span>
    <span class="n">by_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; by=</span><span class="si">{</span><span class="n">performed_by</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">performed_by</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    
    <span class="c1"># Format details</span>
    <span class="n">detail_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
        <span class="n">detail_parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">details</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">detail_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">detail_parts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="n">biometric_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">user_info</span><span class="si">}{</span><span class="n">by_info</span><span class="si">}{</span><span class="n">detail_str</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="log_error">
<a class="viewcode-back" href="../../webserver.html#webserver.logger.log_error">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span>
    <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span>
    <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log an application error or exception to the error log.</span>

<span class="sd">    Args:</span>
<span class="sd">        error (Exception): Exception object to log.</span>
<span class="sd">        context (Optional[str]): Context where the error occurred (e.g., endpoint, function name).</span>
<span class="sd">        user (Optional[str]): Authenticated username, if available.</span>
<span class="sd">        ip (Optional[str]): Client IP address, if available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">context_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; in </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">context</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">user_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; user=</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">user</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ip_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; ip=</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">ip</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    
    <span class="n">error_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="si">}{</span><span class="n">context_info</span><span class="si">}{</span><span class="n">user_info</span><span class="si">}{</span><span class="n">ip_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Include stack trace</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="log_job">
<a class="viewcode-back" href="../../webserver.html#webserver.logger.log_job">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_job</span><span class="p">(</span>
    <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">job_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">created_by</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log a background job event to the access log.</span>

<span class="sd">    Args:</span>
<span class="sd">        job_id (str): Unique job identifier.</span>
<span class="sd">        job_type (str): Type of job (e.g., LOAD_FOLDER).</span>
<span class="sd">        status (str): Job status (CREATED, PROCESSING, COMPLETED, FAILED).</span>
<span class="sd">        details (Optional[Dict[str, Any]]): Additional details about the job.</span>
<span class="sd">        created_by (Optional[str]): Username who created the job.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">by_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; by=</span><span class="si">{</span><span class="n">created_by</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">created_by</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    
    <span class="n">detail_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
        <span class="n">detail_parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">details</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">detail_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">detail_parts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="n">access_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;JOB </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> - type=</span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s2"> id=</span><span class="si">{</span><span class="n">job_id</span><span class="si">}{</span><span class="n">by_info</span><span class="si">}{</span><span class="n">detail_str</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="log_startup">
<a class="viewcode-back" href="../../webserver.html#webserver.logger.log_startup">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_startup</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log server startup information to the access log.</span>

<span class="sd">    Args:</span>
<span class="sd">        info (Dict[str, Any]): Startup information such as host, port, SSL, number of templates, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">access_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">access_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WEBSERVER STARTING&quot;</span><span class="p">)</span>
    <span class="n">access_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">access_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">access_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span></div>



<div class="viewcode-block" id="log_shutdown">
<a class="viewcode-back" href="../../webserver.html#webserver.logger.log_shutdown">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_shutdown</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log server shutdown event to the access log.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">access_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="n">access_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WEBSERVER SHUTTING DOWN&quot;</span><span class="p">)</span>
    <span class="n">access_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span></div>



<span class="c1"># JSON structured logging (for external log aggregation)</span>

<div class="viewcode-block" id="log_json">
<a class="viewcode-back" href="../../webserver.html#webserver.logger.log_json">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_json</span><span class="p">(</span>
    <span class="n">logger_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log structured JSON data to the specified logger for external log aggregation.</span>

<span class="sd">    Args:</span>
<span class="sd">        logger_type (str): Logger to use (&#39;access&#39;, &#39;auth&#39;, &#39;biometric&#39;, &#39;error&#39;).</span>
<span class="sd">        data (Dict[str, Any]): Dictionary to log as JSON.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loggers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;access&#39;</span><span class="p">:</span> <span class="n">access_logger</span><span class="p">,</span>
        <span class="s1">&#39;auth&#39;</span><span class="p">:</span> <span class="n">auth_logger</span><span class="p">,</span>
        <span class="s1">&#39;biometric&#39;</span><span class="p">:</span> <span class="n">biometric_logger</span><span class="p">,</span>
        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">error_logger</span>
    <span class="p">}</span>
    
    <span class="n">logger</span> <span class="o">=</span> <span class="n">loggers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">logger_type</span><span class="p">,</span> <span class="n">access_logger</span><span class="p">)</span>
    
    <span class="c1"># Add timestamp</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span></div>



<span class="c1"># Get logger by name (for custom usage)</span>

<div class="viewcode-block" id="get_logger">
<a class="viewcode-back" href="../../webserver.html#webserver.logger.get_logger">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_logger</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a custom logger that writes to error.log, for specialized logging needs.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): Logger name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        logging.Logger: Logger instance for custom usage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_get_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;webserver.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ERROR_LOG</span><span class="p">)</span></div>



<span class="c1"># Cleanup old logs (optional utility)</span>

<div class="viewcode-block" id="cleanup_old_logs">
<a class="viewcode-back" href="../../webserver.html#webserver.logger.cleanup_old_logs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cleanup_old_logs</span><span class="p">(</span><span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete log files older than the specified number of days from the log directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        days (int): Age threshold in days. Files older than this will be deleted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
    
    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">days</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">)</span>
    
    <span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">log_file</span> <span class="ow">in</span> <span class="n">LOG_DIR</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.log*&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span>
            <span class="n">log_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="n">deleted</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="n">access_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaned up </span><span class="si">{</span><span class="n">deleted</span><span class="si">}</span><span class="s2"> old log files&quot;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Test logging</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Testing webserver logging...&quot;</span><span class="p">)</span>
    
    <span class="n">log_access</span><span class="p">(</span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;/api/users&quot;</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mf">1234.56</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
    <span class="n">log_auth</span><span class="p">(</span><span class="s2">&quot;LOGIN&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;192.168.1.100&quot;</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">log_biometric</span><span class="p">(</span><span class="s2">&quot;ENROLL&quot;</span><span class="p">,</span> <span class="s2">&quot;user123&quot;</span><span class="p">,</span> <span class="s2">&quot;SUCCESS&quot;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;quality&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;minutiae&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">})</span>
    <span class="n">log_error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Test error&quot;</span><span class="p">),</span> <span class="n">context</span><span class="o">=</span><span class="s2">&quot;/api/test&quot;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">âœ“ Logs written to </span><span class="si">{</span><span class="n">LOG_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">ACCESS_LOG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">AUTH_LOG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">BIOMETRIC_LOG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">ERROR_LOG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Daniel Barreiros.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
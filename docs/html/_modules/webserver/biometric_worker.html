

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>webserver.biometric_worker &mdash; Supermatcher 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Supermatcher
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Supermatcher</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">webserver.biometric_worker</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for webserver.biometric_worker</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Biometric Worker Functions for ProcessPool</span>

<span class="sd">This module provides isolated worker functions for CPU-bound biometric operations, designed to run in separate processes via ProcessPoolExecutor.</span>
<span class="sd">Functions include 1:1 verification, 1:N identification, user enrollment, and batch folder loading. All heavy imports (e.g., supermatcher) are performed inside the worker functions to avoid pickling issues and maximize multiprocessing efficiency.</span>

<span class="sd">Multiprocessing Strategy:</span>
<span class="sd">     1. VERIFY (1:1 matching): No multiprocessing within a single request; server-level parallelism only.</span>
<span class="sd">     2. IDENTIFY (1:N matching): Adaptive multiprocessing; sequential for small galleries, parallel for large galleries (â‰¥20 users).</span>
<span class="sd">     3. ADD_USER (enrollment): No multiprocessing within a single user; server-level parallelism for multiple requests.</span>
<span class="sd">     4. LOAD_FOLDER (batch enrollment): Full multiprocessing; each user enrolled in parallel.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>


<div class="viewcode-block" id="worker_match_probe_against_gallery_chunk">
<a class="viewcode-back" href="../../webserver.html#webserver.biometric_worker.worker_match_probe_against_gallery_chunk">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">worker_match_probe_against_gallery_chunk</span><span class="p">(</span>
    <span class="n">probe_secure_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">gallery_chunk_secure_dicts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">hasher_params</span><span class="p">:</span> <span class="nb">dict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Match a probe fingerprint against a chunk of gallery templates in parallel.</span>

<span class="sd">    Used for parallel identification in large galleries. Each chunk is processed in a separate process.</span>

<span class="sd">    Args:</span>
<span class="sd">        probe_secure_dict (Dict[str, Any]): Secure dict of the probe FingerprintTemplate.</span>
<span class="sd">        gallery_chunk_secure_dicts (Dict[str, Dict[str, Any]]): Mapping of user_id to secure dict for a subset of the gallery.</span>
<span class="sd">        hasher_params (dict): Parameters for the CancelableHasher.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[Tuple[str, float]]: List of (user_id, score) tuples for this chunk.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.models_serialization</span><span class="w"> </span><span class="kn">import</span> <span class="n">template_from_secure_dict</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.template_creation</span><span class="w"> </span><span class="kn">import</span> <span class="n">CancelableHasher</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.matching</span><span class="w"> </span><span class="kn">import</span> <span class="n">FingerprintMatcher</span>
        
        <span class="c1"># Deserialize probe</span>
        <span class="n">probe_template</span> <span class="o">=</span> <span class="n">template_from_secure_dict</span><span class="p">(</span><span class="n">probe_secure_dict</span><span class="p">)</span>
        
        <span class="c1"># Deserialize gallery chunk</span>
        <span class="n">gallery_templates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">template_from_secure_dict</span><span class="p">(</span><span class="n">tpl_dict</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">tpl_dict</span> <span class="ow">in</span> <span class="n">gallery_chunk_secure_dicts</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span>
        
        <span class="c1"># Create hasher</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="n">CancelableHasher</span><span class="p">(</span>
            <span class="n">feature_dim</span><span class="o">=</span><span class="n">hasher_params</span><span class="p">[</span><span class="s1">&#39;feature_dim&#39;</span><span class="p">],</span>
            <span class="n">projection_dim</span><span class="o">=</span><span class="n">hasher_params</span><span class="p">[</span><span class="s1">&#39;projection_dim&#39;</span><span class="p">],</span>
            <span class="n">key</span><span class="o">=</span><span class="n">hasher_params</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span>
            <span class="n">hash_count</span><span class="o">=</span><span class="n">hasher_params</span><span class="p">[</span><span class="s1">&#39;hash_count&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="c1"># Create matcher for this chunk</span>
        <span class="n">matcher</span> <span class="o">=</span> <span class="n">FingerprintMatcher</span><span class="p">(</span><span class="n">gallery_templates</span><span class="p">,</span> <span class="n">hasher</span><span class="p">)</span>
        
        <span class="c1"># Match probe against this chunk</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span>
            <span class="n">probe_template</span><span class="p">,</span> 
            <span class="n">top_k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gallery_templates</span><span class="p">),</span>  <span class="c1"># Get all matches from this chunk</span>
            <span class="n">use_geometric_reranking</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>  <span class="c1"># List of (user_id, score)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR worker_match_chunk] </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="worker_enroll_single_user">
<a class="viewcode-back" href="../../webserver.html#webserver.biometric_worker.worker_enroll_single_user">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">worker_enroll_single_user</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">image_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enroll a single user from multiple fingerprint images (for parallel processing).</span>

<span class="sd">    Args:</span>
<span class="sd">        user_id (str): User identifier.</span>
<span class="sd">        image_paths (List[str]): List of image file paths for this user.</span>
<span class="sd">        settings (dict): Enrollment settings, including &#39;quality_threshold&#39; and &#39;fusion&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Enrollment result with keys:</span>
<span class="sd">            - &#39;success&#39; (bool): Whether enrollment succeeded.</span>
<span class="sd">            - &#39;user_id&#39; (str): User identifier.</span>
<span class="sd">            - &#39;template_secure&#39; (dict): Secure serialization of the template.</span>
<span class="sd">            - &#39;quality&#39; (float): Quality score of the template.</span>
<span class="sd">            - &#39;num_images&#39; (int): Number of images used.</span>
<span class="sd">            - &#39;error&#39; (Optional[str]): Error message if enrollment failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Import supermatcher INSIDE worker (avoid pickling issues)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.supermatcher_v1_0</span><span class="w"> </span><span class="kn">import</span> <span class="n">enroll</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">FusionSettings</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.models_serialization</span><span class="w"> </span><span class="kn">import</span> <span class="n">template_to_secure_dict</span>
        
        <span class="c1"># Convert string paths to Path objects</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">image_paths</span><span class="p">]</span>
        
        <span class="c1"># Create fusion settings</span>
        <span class="n">fusion_dict</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fusion&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">fusion</span> <span class="o">=</span> <span class="n">FusionSettings</span><span class="p">(</span>
            <span class="n">enabled</span><span class="o">=</span><span class="n">fusion_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">distance</span><span class="o">=</span><span class="n">fusion_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">),</span>
            <span class="n">angle_deg</span><span class="o">=</span><span class="n">fusion_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;angle_deg&#39;</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">),</span>
            <span class="n">min_consensus</span><span class="o">=</span><span class="n">fusion_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_consensus&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="n">keep_raw</span><span class="o">=</span><span class="n">fusion_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep_raw&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">fusion_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;optimal&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Enroll user</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="n">enroll</span><span class="p">(</span>
            <span class="n">image_paths</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">fusion_settings</span><span class="o">=</span><span class="n">fusion</span><span class="p">,</span>
            <span class="n">quality_threshold</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quality_threshold&#39;</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">),</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">templates</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                <span class="s1">&#39;template_secure&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s1">&#39;num_images&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_paths</span><span class="p">),</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No valid templates extracted&#39;</span>
            <span class="p">}</span>
        
        <span class="n">template</span> <span class="o">=</span> <span class="n">templates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s1">&#39;template_secure&#39;</span><span class="p">:</span> <span class="n">template_to_secure_dict</span><span class="p">(</span><span class="n">template</span><span class="p">),</span>
            <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">quality</span><span class="p">),</span>
            <span class="s1">&#39;num_images&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_paths</span><span class="p">),</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
    
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s1">&#39;template_pickle&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;num_images&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_paths</span><span class="p">)</span> <span class="k">if</span> <span class="n">image_paths</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">}</span></div>



<div class="viewcode-block" id="worker_enroll">
<a class="viewcode-back" href="../../webserver.html#webserver.biometric_worker.worker_enroll">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">worker_enroll</span><span class="p">(</span>
    <span class="n">image_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enroll a user from a list of fingerprint images (runs in ProcessPool).</span>

<span class="sd">    Args:</span>
<span class="sd">        image_paths (List[str]): List of image file paths.</span>
<span class="sd">        user_id (str): User identifier.</span>
<span class="sd">        settings (dict): Enrollment settings, including &#39;quality_threshold&#39; and &#39;fusion&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Enrollment result with keys:</span>
<span class="sd">            - &#39;success&#39; (bool): Whether enrollment succeeded.</span>
<span class="sd">            - &#39;template_secure&#39; (dict): Secure serialization of the template.</span>
<span class="sd">            - &#39;quality&#39; (float): Quality score of the template.</span>
<span class="sd">            - &#39;num_images&#39; (int): Number of images used.</span>
<span class="sd">            - &#39;error&#39; (Optional[str]): Error message if enrollment failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Import supermatcher INSIDE worker (avoid pickling issues)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.supermatcher_v1_0</span><span class="w"> </span><span class="kn">import</span> <span class="n">enroll</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">FusionSettings</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.models_serialization</span><span class="w"> </span><span class="kn">import</span> <span class="n">template_to_secure_dict</span>
        
        <span class="c1"># Convert paths to Path objects</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">image_paths</span><span class="p">]</span>
        
        <span class="c1"># Create fusion settings from dict</span>
        <span class="n">fusion_dict</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fusion&#39;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="c1"># Map frontend params to FusionSettings params</span>
        <span class="n">fusion</span> <span class="o">=</span> <span class="n">FusionSettings</span><span class="p">(</span>
            <span class="n">enabled</span><span class="o">=</span><span class="n">fusion_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">distance</span><span class="o">=</span><span class="n">fusion_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">),</span>
            <span class="n">angle_deg</span><span class="o">=</span><span class="n">fusion_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;angle_deg&#39;</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">),</span>
            <span class="n">min_consensus</span><span class="o">=</span><span class="n">fusion_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_consensus&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="n">keep_raw</span><span class="o">=</span><span class="n">fusion_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep_raw&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">fusion_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;optimal&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Enroll</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="n">enroll</span><span class="p">(</span>
            <span class="n">image_paths</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">fusion_settings</span><span class="o">=</span><span class="n">fusion</span><span class="p">,</span>
            <span class="n">quality_threshold</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quality_threshold&#39;</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">),</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">templates</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;template_secure&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s1">&#39;num_images&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No valid templates extracted&#39;</span>
            <span class="p">}</span>
        
        <span class="c1"># Get master template</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">templates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;template_secure&#39;</span><span class="p">:</span> <span class="n">template_to_secure_dict</span><span class="p">(</span><span class="n">template</span><span class="p">),</span>
            <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">quality</span><span class="p">),</span>
            <span class="s1">&#39;num_images&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_paths</span><span class="p">),</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
    
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;template_secure&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;num_images&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">}</span></div>



<div class="viewcode-block" id="worker_verify">
<a class="viewcode-back" href="../../webserver.html#webserver.biometric_worker.worker_verify">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">worker_verify</span><span class="p">(</span>
    <span class="n">probe_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">template_secure_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform 1:1 fingerprint verification between a probe image and an enrolled template.</span>

<span class="sd">    Args:</span>
<span class="sd">        probe_path (str): Path to the probe image file.</span>
<span class="sd">        template_secure_dict (Dict[str, Any]): Secure dict of the enrolled FingerprintTemplate.</span>
<span class="sd">        threshold (float): Verification threshold for a match.</span>
<span class="sd">        settings (dict): Matching settings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Verification result with keys:</span>
<span class="sd">            - &#39;success&#39; (bool): Whether verification succeeded.</span>
<span class="sd">            - &#39;match&#39; (bool): Whether the probe matches the template.</span>
<span class="sd">            - &#39;score&#39; (float): Combined match score.</span>
<span class="sd">            - &#39;num_matched&#39; (int): Number of matched minutiae (approximate).</span>
<span class="sd">            - &#39;error&#39; (Optional[str]): Error message if verification failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Import supermatcher INSIDE worker</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.supermatcher_v1_0</span><span class="w"> </span><span class="kn">import</span> <span class="n">FingerprintPipeline</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.template_creation</span><span class="w"> </span><span class="kn">import</span> <span class="n">CancelableHasher</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">HASH_FEATURE_DIM</span><span class="p">,</span> <span class="n">HASH_PROJECTION_DIM</span><span class="p">,</span> <span class="n">HASH_KEY</span><span class="p">,</span> <span class="n">HASH_COUNT</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.models_serialization</span><span class="w"> </span><span class="kn">import</span> <span class="n">template_from_secure_dict</span>
        
        <span class="c1"># Deserialize enrolled template</span>
        <span class="n">enrolled_template</span> <span class="o">=</span> <span class="n">template_from_secure_dict</span><span class="p">(</span><span class="n">template_secure_dict</span><span class="p">)</span>
        
        <span class="c1"># Create pipeline and process probe image (eliminates code duplication!)</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="n">CancelableHasher</span><span class="p">(</span>
            <span class="n">feature_dim</span><span class="o">=</span><span class="n">HASH_FEATURE_DIM</span><span class="p">,</span>
            <span class="n">projection_dim</span><span class="o">=</span><span class="n">HASH_PROJECTION_DIM</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">HASH_KEY</span><span class="p">,</span>
            <span class="n">hash_count</span><span class="o">=</span><span class="n">HASH_COUNT</span>
        <span class="p">)</span>
        
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">FingerprintPipeline</span><span class="p">(</span>
            <span class="n">hasher</span><span class="o">=</span><span class="n">hasher</span><span class="p">,</span>
            <span class="n">include_level3</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="n">probe_template</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
            <span class="n">image_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">probe_path</span><span class="p">),</span>
            <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;probe&quot;</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="c1"># Get hash similarity</span>
        <span class="n">hash_similarity</span> <span class="o">=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">similarity</span><span class="p">(</span><span class="n">probe_template</span><span class="o">.</span><span class="n">protected</span><span class="p">,</span> <span class="n">enrolled_template</span><span class="o">.</span><span class="n">protected</span><span class="p">)</span>
        
        <span class="c1"># Compute geometric score</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.matching</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_geometric_minutiae_score</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">MATCH_DISTANCE_THRESHOLD</span><span class="p">,</span> <span class="n">MATCH_ANGLE_THRESHOLD_RAD</span>
        
        <span class="n">probe_min</span> <span class="o">=</span> <span class="n">probe_template</span><span class="o">.</span><span class="n">minutiae</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">enrolled_min</span> <span class="o">=</span> <span class="n">enrolled_template</span><span class="o">.</span><span class="n">minutiae</span> <span class="ow">or</span> <span class="p">[]</span>
        
        <span class="n">geometric_score</span> <span class="o">=</span> <span class="n">compute_geometric_minutiae_score</span><span class="p">(</span>
            <span class="n">probe_min</span><span class="p">,</span>
            <span class="n">enrolled_min</span><span class="p">,</span>
            <span class="n">distance_threshold</span><span class="o">=</span><span class="n">MATCH_DISTANCE_THRESHOLD</span><span class="p">,</span>
            <span class="n">angle_threshold</span><span class="o">=</span><span class="n">MATCH_ANGLE_THRESHOLD_RAD</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="c1"># Combined score: 60% hash + 40% geometric (matching config)</span>
        <span class="n">combined_score</span> <span class="o">=</span> <span class="mf">0.60</span> <span class="o">*</span> <span class="n">hash_similarity</span> <span class="o">+</span> <span class="mf">0.40</span> <span class="o">*</span> <span class="n">geometric_score</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">combined_score</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
        
        <span class="c1"># Approximate number of matched minutiae (from geometric score)</span>
        <span class="c1"># geometric_score is roughly (matched / max(n_probe, n_candidate))</span>
        <span class="n">max_minutiae</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">probe_min</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">enrolled_min</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">probe_min</span> <span class="ow">and</span> <span class="n">enrolled_min</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">num_matched</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">geometric_score</span> <span class="o">*</span> <span class="n">max_minutiae</span><span class="p">)</span> <span class="k">if</span> <span class="n">geometric_score</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">max_minutiae</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># DEBUG: Print detailed info</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG worker_verify] hash=</span><span class="si">{</span><span class="n">hash_similarity</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, geometric=</span><span class="si">{</span><span class="n">geometric_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;combined=</span><span class="si">{</span><span class="n">combined_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, threshold=</span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, match=</span><span class="si">{</span><span class="n">match</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;num_matched=</span><span class="si">{</span><span class="n">num_matched</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_minutiae</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;match&#39;</span><span class="p">:</span> <span class="n">match</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_score</span><span class="p">),</span>
            <span class="s1">&#39;hash_score&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">hash_similarity</span><span class="p">),</span>
            <span class="s1">&#39;geometric_score&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">geometric_score</span><span class="p">),</span>
            <span class="s1">&#39;num_matched&#39;</span><span class="p">:</span> <span class="n">num_matched</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
    
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;match&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;num_matched&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">}</span></div>



<div class="viewcode-block" id="worker_identify">
<a class="viewcode-back" href="../../webserver.html#webserver.biometric_worker.worker_identify">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">worker_identify</span><span class="p">(</span>
    <span class="n">probe_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">gallery_secure_dicts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform 1:N fingerprint identification of a probe image against a gallery.</span>

<span class="sd">    Args:</span>
<span class="sd">        probe_path (str): Path to the probe image file.</span>
<span class="sd">        gallery_secure_dicts (Dict[str, Dict[str, Any]]): Mapping of user_id to secure dict of FingerprintTemplate.</span>
<span class="sd">        threshold (float): Identification threshold for a match.</span>
<span class="sd">        settings (dict): Matching settings.</span>
<span class="sd">        top_k (int, optional): Number of top matches to return. Defaults to 5.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Identification result with keys:</span>
<span class="sd">            - &#39;success&#39; (bool): Whether identification succeeded.</span>
<span class="sd">            - &#39;matches&#39; (List[dict]): List of matches with user_id, score, and num_matched.</span>
<span class="sd">            - &#39;identified&#39; (bool): Whether a match above threshold was found.</span>
<span class="sd">            - &#39;best_match_id&#39; (Optional[str]): User ID of the best match, if any.</span>
<span class="sd">            - &#39;best_score&#39; (float): Score of the best match.</span>
<span class="sd">            - &#39;error&#39; (Optional[str]): Error message if identification failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Import supermatcher INSIDE worker</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.supermatcher_v1_0</span><span class="w"> </span><span class="kn">import</span> <span class="n">FingerprintPipeline</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.template_creation</span><span class="w"> </span><span class="kn">import</span> <span class="n">CancelableHasher</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.matching</span><span class="w"> </span><span class="kn">import</span> <span class="n">FingerprintMatcher</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">HASH_FEATURE_DIM</span><span class="p">,</span> <span class="n">HASH_PROJECTION_DIM</span><span class="p">,</span> <span class="n">HASH_KEY</span><span class="p">,</span> <span class="n">HASH_COUNT</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.models_serialization</span><span class="w"> </span><span class="kn">import</span> <span class="n">template_from_secure_dict</span><span class="p">,</span> <span class="n">template_to_secure_dict</span>
        
        <span class="c1"># Deserialize all gallery templates</span>
        <span class="n">gallery_templates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">template_secure_dict</span> <span class="ow">in</span> <span class="n">gallery_secure_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">template_from_secure_dict</span><span class="p">(</span><span class="n">template_secure_dict</span><span class="p">)</span>
            <span class="n">gallery_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gallery_templates</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;matches&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;identified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;best_match_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No templates in gallery&#39;</span>
            <span class="p">}</span>
        
        <span class="c1"># Create pipeline and process probe image (eliminates code duplication!)</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="n">CancelableHasher</span><span class="p">(</span>
            <span class="n">feature_dim</span><span class="o">=</span><span class="n">HASH_FEATURE_DIM</span><span class="p">,</span>
            <span class="n">projection_dim</span><span class="o">=</span><span class="n">HASH_PROJECTION_DIM</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">HASH_KEY</span><span class="p">,</span>
            <span class="n">hash_count</span><span class="o">=</span><span class="n">HASH_COUNT</span>
        <span class="p">)</span>
        
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">FingerprintPipeline</span><span class="p">(</span>
            <span class="n">hasher</span><span class="o">=</span><span class="n">hasher</span><span class="p">,</span>
            <span class="n">include_level3</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="n">probe_template</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
            <span class="n">image_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">probe_path</span><span class="p">),</span>
            <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;probe&quot;</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="c1"># OPTIMIZATION: Use multiprocessing for large galleries (â‰¥20 users)</span>
        <span class="n">gallery_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gallery_templates</span><span class="p">)</span>
        <span class="n">USE_PARALLEL</span> <span class="o">=</span> <span class="n">gallery_size</span> <span class="o">&gt;=</span> <span class="mi">20</span>
        
        <span class="k">if</span> <span class="n">USE_PARALLEL</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG worker_identify] Large gallery (</span><span class="si">{</span><span class="n">gallery_size</span><span class="si">}</span><span class="s2"> users), using PARALLEL matching&quot;</span><span class="p">)</span>
            
            <span class="c1"># Prepare for parallel processing</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
            
            <span class="c1"># Serialize probe template once (secure dict)</span>
            <span class="n">probe_secure_dict</span> <span class="o">=</span> <span class="n">template_to_secure_dict</span><span class="p">(</span><span class="n">probe_template</span><span class="p">)</span>
            
            <span class="c1"># Prepare hasher params</span>
            <span class="n">hasher_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;feature_dim&#39;</span><span class="p">:</span> <span class="n">HASH_FEATURE_DIM</span><span class="p">,</span>
                <span class="s1">&#39;projection_dim&#39;</span><span class="p">:</span> <span class="n">HASH_PROJECTION_DIM</span><span class="p">,</span>
                <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">HASH_KEY</span><span class="p">,</span>
                <span class="s1">&#39;hash_count&#39;</span><span class="p">:</span> <span class="n">HASH_COUNT</span>
            <span class="p">}</span>
            
            <span class="c1"># Split gallery into chunks (1 chunk per CPU core)</span>
            <span class="n">num_workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="n">gallery_size</span><span class="p">)</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gallery_size</span> <span class="o">//</span> <span class="n">num_workers</span><span class="p">)</span>
            
            <span class="n">gallery_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gallery_secure_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">gallery_items</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gallery_items</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)</span>
            <span class="p">]</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Splitting </span><span class="si">{</span><span class="n">gallery_size</span><span class="si">}</span><span class="s2"> templates into </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span><span class="si">}</span><span class="s2"> chunks, using </span><span class="si">{</span><span class="n">num_workers</span><span class="si">}</span><span class="s2"> workers&quot;</span><span class="p">)</span>
            
            <span class="c1"># Process chunks in parallel</span>
            <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">worker_match_probe_against_gallery_chunk</span><span class="p">,</span> <span class="n">probe_secure_dict</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">hasher_params</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span>
                <span class="p">]</span>
                
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">chunk_results</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                        <span class="n">all_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chunk_results</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR identify_chunk] </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Sort all results by score (descending)</span>
            <span class="n">all_results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Take top_k</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">all_results</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># SEQUENTIAL: For small galleries, use standard FingerprintMatcher</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG worker_identify] Small gallery (</span><span class="si">{</span><span class="n">gallery_size</span><span class="si">}</span><span class="s2"> users), using SEQUENTIAL matching&quot;</span><span class="p">)</span>
            
            <span class="n">matcher</span> <span class="o">=</span> <span class="n">FingerprintMatcher</span><span class="p">(</span><span class="n">gallery_templates</span><span class="p">,</span> <span class="n">hasher</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span><span class="n">probe_template</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span> <span class="n">use_geometric_reranking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Format results</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">),</span>
                <span class="s1">&#39;num_matched&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">results</span>
        <span class="p">]</span>
        
        <span class="n">identified</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;matches&#39;</span><span class="p">:</span> <span class="n">matches</span><span class="p">,</span>
            <span class="s1">&#39;identified&#39;</span><span class="p">:</span> <span class="n">identified</span><span class="p">,</span>
            <span class="s1">&#39;best_match_id&#39;</span><span class="p">:</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">matches</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">matches</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
    
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;matches&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;identified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;best_match_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">}</span></div>



<div class="viewcode-block" id="worker_load_folder">
<a class="viewcode-back" href="../../webserver.html#webserver.biometric_worker.worker_load_folder">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">worker_load_folder</span><span class="p">(</span>
    <span class="n">folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Batch-enroll all users from a folder structure using parallel processing.</span>

<span class="sd">    Expects folder structure:</span>
<span class="sd">        folder_path/</span>
<span class="sd">            user1/</span>
<span class="sd">                img1.png</span>
<span class="sd">                img2.png</span>
<span class="sd">            user2/</span>
<span class="sd">                img1.png</span>
<span class="sd">                img2.png</span>

<span class="sd">    Args:</span>
<span class="sd">        folder_path (str): Path to the folder containing user subfolders or flat image files.</span>
<span class="sd">        settings (dict): Enrollment settings.</span>
<span class="sd">        progress_callback (Optional[Callable]): Optional callback function called as progress is made.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Batch enrollment result with keys:</span>
<span class="sd">            - &#39;success&#39; (bool): Whether the operation succeeded.</span>
<span class="sd">            - &#39;enrolled&#39; (List[dict]): List of successfully enrolled users with user_id, template_secure, and quality.</span>
<span class="sd">            - &#39;failed&#39; (List[dict]): List of failed enrollments with user_id and error.</span>
<span class="sd">            - &#39;total&#39; (int): Total number of users processed.</span>
<span class="sd">            - &#39;error&#39; (Optional[str]): Error message if the operation failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Import supermatcher INSIDE worker</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.supermatcher_v1_0</span><span class="w"> </span><span class="kn">import</span> <span class="n">enroll</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">FusionSettings</span>
        
        <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;enrolled&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Folder not found: </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">}</span>
        
        <span class="c1"># Check if folder has subfolders or direct image files</span>
        <span class="n">has_subfolders</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG worker_load_folder] folder_path=</span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG worker_load_folder] has_subfolders=</span><span class="si">{</span><span class="n">has_subfolders</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">enrolled</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Two modes: subfolders (user1/, user2/) or flat structure (101_1.tif, 101_2.tif)</span>
        <span class="k">if</span> <span class="n">has_subfolders</span><span class="p">:</span>
            <span class="c1"># Original mode: folder/user1/img1.png, folder/user2/img1.png</span>
            <span class="n">user_folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Subfolder mode: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">user_folders</span><span class="p">)</span><span class="si">}</span><span class="s2"> user folders found&quot;</span><span class="p">)</span>
            <span class="n">user_images_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">user_folders</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Flat mode: group files by prefix (101_1.tif, 101_2.tif -&gt; user 101)</span>
            <span class="n">image_extensions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;.bmp&#39;</span><span class="p">}</span>
            <span class="n">all_files</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">image_extensions</span>
            <span class="p">]</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Flat mode: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> image files found&quot;</span><span class="p">)</span>
            
            <span class="c1"># Group files by user ID (extract prefix before underscore or digit break)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
            <span class="n">user_images_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
                <span class="c1"># Extract user ID from filename (e.g., &quot;101_1.tif&quot; -&gt; &quot;101&quot;)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">stem</span>  <span class="c1"># Remove extension</span>
                
                <span class="c1"># Try to extract user ID (digits before underscore or end)</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\d+)&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">user_id</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">user_images_map</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Skip files that don&#39;t match pattern</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Skipping file with no user ID pattern: </span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Grouped into </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">user_images_map</span><span class="p">)</span><span class="si">}</span><span class="s2"> users: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">user_images_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Prepare arguments for parallel processing</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Starting parallel enrollment for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">user_images_map</span><span class="p">)</span><span class="si">}</span><span class="s2"> users...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Use multiprocessing to process users in parallel</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
        
        <span class="c1"># Use all available CPUs (or max 8)</span>
        <span class="n">max_workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="mi">8</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Using </span><span class="si">{</span><span class="n">max_workers</span><span class="si">}</span><span class="s2"> worker processes&quot;</span><span class="p">)</span>
        
        <span class="n">enrolled</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Create list of tasks: (user_id, image_paths_as_strings, settings)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">image_paths</span> <span class="ow">in</span> <span class="n">user_images_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Convert Path objects to strings for pickling</span>
            <span class="n">image_path_strings</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">image_paths</span><span class="p">]</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">user_id</span><span class="p">,</span> <span class="n">image_path_strings</span><span class="p">,</span> <span class="n">settings</span><span class="p">))</span>
        
        <span class="c1"># Process users in parallel</span>
        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="c1"># Submit all tasks</span>
            <span class="n">future_to_user</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">worker_enroll_single_user</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">img_paths</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span> <span class="n">user_id</span>
                <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">img_paths</span><span class="p">,</span> <span class="n">settings</span> <span class="ow">in</span> <span class="n">tasks</span>
            <span class="p">}</span>
            
            <span class="c1"># Collect results as they complete</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_user</span><span class="p">):</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">future_to_user</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    
                    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
                        <span class="n">enrolled</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;template_secure&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;template_secure&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;num_images&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;num_images&#39;</span><span class="p">]</span>
                        <span class="p">})</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] âœ“ User </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> enrolled (quality=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
                        <span class="p">})</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] âœ— User </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
                        <span class="n">progress_callback</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">&#39;completed&#39;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;failed&#39;</span><span class="p">)</span>
                        
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">})</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] âœ— User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
                        <span class="n">progress_callback</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Load folder complete: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">enrolled</span><span class="p">)</span><span class="si">}</span><span class="s2"> enrolled, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">failed</span><span class="p">)</span><span class="si">}</span><span class="s2"> failed&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;enrolled&#39;</span><span class="p">:</span> <span class="n">enrolled</span><span class="p">,</span>
            <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="n">failed</span><span class="p">,</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_images_map</span><span class="p">),</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
    
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;enrolled&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">}</span></div>



<span class="c1"># Test function</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Testing biometric worker functions...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Note: These tests require actual images and templates</span>
    <span class="c1"># For real testing, provide actual paths</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">âœ“ Worker functions defined successfully&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - worker_enroll()&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - worker_verify()&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - worker_identify()&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - worker_load_folder()&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Daniel Barreiros.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>